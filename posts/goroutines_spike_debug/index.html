<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Goroutines spike debug &#183; Luckmu's writepad</title><meta name=description content><link type=text/css rel=stylesheet href=https://luckmu.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://luckmu.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://luckmu.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://luckmu.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://luckmu.github.io/><h1>Luckmu's writepad</h1></a><p class=lead>Luckmu's daily writings.</p></div><nav><ul class=sidebar-nav><li><a href=https://luckmu.github.io/>Home</a></li><li><a href=/tags/>Tags</a></li><li><a href=/categories/>Categories</a></li></ul></nav><p>&copy; 2023. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Goroutines spike debug</h1><time datetime=2023-02-23T23:24:01+0800 class=post-date>Thu, Feb 23, 2023</time><p>有关 <code>http.Client</code> 正确使用, 根据 <code>net/http/pprof</code> 和 <code>netstat</code> 排查问题的记录。</p><p>之前一段时间现网服务出现 goroutines 数量尖刺的表现，让排查下问题。</p><p>表现为 goroutines 有尖刺，打开文件数有尖刺，两者曲线吻合。</p><p>于是先在测试环境来 1 发 <code>import _ "net/http/pprof"</code>, 发现经常数量最高是 <code>write_loop</code> 和 <code>read_loop</code> 两类协程。</p><p>观察 <code>/proc/$pid/fd</code> 文件数量, 全是 socket 连接, 于是 <code>netstat -tn | grep ESTABLISED</code> 发现有大量到同 1 dst 的连接。</p><p>本服务需要经常查询 dst，但都是串行，且都有 close 掉 response.Body，为什么会出现这种情况呢？</p><p>再仔细排查，每次 query 都新 new 了 1 个 <code>http.Client</code>, 自定义 transport 后使用默认 keepalive 时长 15s。</p><p>这样即使 query 是串行, connections 和 goroutines 也会在 15s 内累积。</p><p>验证：</p><ol><li><code>import _ "net/http/pprof"</code> 观察实时 goroutines 数量, 与 <code>watch -n1 "netstat -tn | grep dst:port | grep ESTABLISED"</code> 观察实时连接数, 发现吻合。</li><li><code>transport.DisableKeepAlives = true</code>, 发现到 dst 的连接不再驻留, 并且没有之前那样大量 goroutines 驻留。</li></ol><p>OK, 剩下的就是 fix 代码了, 使用 1 个 <code>http.Client</code> 实例即可, 且本身 <code>http.Client</code> 也是可复用的, 还能有效利用连接池, 减少资源浪费。</p></div></main></body></html>